<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner un codeâ€‘barres</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 20px; }
  video { width: 100%; max-width: 520px; border-radius: 12px; }
  .out { margin-top: 12px; white-space: pre-wrap; }
</style>

<h1>Scanner un codeâ€‘barres</h1>
<p>Vise lâ€™ISBN (EANâ€‘13). Le rÃ©sultat sâ€™affiche ciâ€‘dessous.</p>
<video id="preview" playsinline muted></video>
<div class="out" id="out">En attenteâ€¦</div>
<button id="stop" disabled>ArrÃªter</button>

<script type="module">
  import { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType }
    from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/+esm";

  const hints = new Map();
  // On se concentre sur les formats utiles pour livres/produits.
  hints.set(DecodeHintType.POSSIBLE_FORMATS, [
    BarcodeFormat.EAN_13, BarcodeFormat.EAN_8, BarcodeFormat.UPC_A
  ]);

  const reader = new BrowserMultiFormatReader(hints);
  const video = document.getElementById("preview");
  const out = document.getElementById("out");
  const stopBtn = document.getElementById("stop");
  let running = false;

  function log(msg){ out.textContent = msg; }

  async function start() {
    if (running) return;
    running = true; stopBtn.disabled = false; log("Initialisation camÃ©raâ€¦");
    // Essaie la camÃ©ra arriÃ¨re quand dispo
    const devices = await reader.listVideoInputDevices();
    const backCam = devices.find(d => /back|arriÃ¨re|rear|environment/i.test(d.label)) || devices[0];
    if (!backCam) return log("Aucune camÃ©ra dÃ©tectÃ©e.");

    reader.decodeFromVideoDevice(backCam.deviceId, video, (result, err) => {
      if (result) {
        const raw = result.text;
        const digits = raw.replace(/\D/g,""); // normalisation
        log(`DÃ©tectÃ© : ${raw}\nNormalisÃ© : ${digits}`);
        // ðŸ‘‰ ici tu as ta STRING de codeâ€‘barres (digits)
        // Ex: envoie vers ton backend:
        // fetch("/books/intake",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({barcode:digits,lang:'fr'})})
        stop();
      }
      // err => bruit normal pendant le scan; on ignore.
    });
  }

  function stop() {
    if (!running) return;
    reader.reset();
    running = false; stopBtn.disabled = true;
  }

  stopBtn.onclick = stop;
  start();
</script>
