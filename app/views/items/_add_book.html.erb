<div data-controller="image-preview">
  <%= form_with model: item,
                url: collection_category_items_path(collection, category),
                scope: :item,
                class: "form-capsule",
                data: { turbo_frame: "_top" } do |f| %>

    <!-- Champs cachés -->
    <%= f.hidden_field :type %>
    <%= f.hidden_field :source %>
    <%= f.hidden_field :source_id %>
    <%= f.hidden_field :barcode %>

    <!-- Input maître caché (seul utilisé par Rails) -->
    <%= f.file_field :photos,
          multiple: true,
          accept: "image/*",
          class: "hidden",
          data: { image_preview_target: "master" } %>

    <!-- Boutons séparés -->
    <div class="action-buttons">
      <div class="buttons-upload action-buttons">
        <label class="image-upload-label">
          Prendre une photo
          <input type="file"
                accept="image/*"
                capture="environment"
                class="hidden"
                data-action="change->image-preview#addFiles">
        </label>

        <label class="image-upload-label">
          Choisir depuis la galerie
          <input type="file"
                accept="image/*"
                multiple
                class="hidden"
                data-action="change->image-preview#addFiles">
        </label>
      </div>
    </div>

    <!-- Prévisualisation -->
    <div class="preview-grid new-grid mb-3" data-image-preview-target="list"></div>

    <!-- Champ Nom -->
    <%= f.text_field :name, class: "input-form" %>

    <!-- Etat -->
    <div class="select-form">
      <%= f.select :state, options_for_select(%w[Neuf Bon Moyen Mauvais]) %>
    </div>

    <!-- Prix -->
    <div class="label_add">
      <%= f.label :price, "Prix" %>
      <div class="price-with-currency">
        <%= f.number_field :price, step: 0.01, placeholder: 0.01, class: "input-form" %>

        <%= select_tag "item[metadata][currency]",
              options_for_select([["€ Euro", "EUR"], ["$ Dollar", "USD"], ["£ Livre", "GBP"], ["¥ Yen", "JPY"]],
                                item.metadata["currency"] || "EUR"),
              class: "input-form" %>
      </div>
    </div>


    <!-- Nombre -->
    <div class="label_add">
      <%= f.label :possession, "Nombre" %>
      <%= f.number_field :possession, placeholder: 1, class: "input-form" %>
    </div>

    <!-- Champs metadata -->
    <div class="label_add">
      <%= f.label :metadata_authors, "Auteur(s)" %>
      <%= text_field_tag "item[metadata][authors]", item.metadata["authors"], class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_publisher, "Éditeur" %>
      <%= text_field_tag "item[metadata][publisher]", item.metadata["publisher"], class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_language, "Langue" %>
      <%= select_tag "item[metadata][language]",
            options_for_select(ItemsHelper::LANGUAGE_NAMES.map { |k,v| [v, k] }, item.metadata["language"]),
            class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_published_date, "Année de publication" %>
      <%= text_field_tag "item[metadata][published_date]",
                        (Date.parse(item.metadata["published_date"]).strftime("%d-%m-%Y") rescue item.metadata["published_date"]),
                        class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_description, "Résumé" %>
      <%= text_area_tag "item[metadata][description]", item.metadata["description"], rows: 6, class: "input-form" %>
    </div>

    <!-- Bouton submit -->
    <%= f.submit "Créer l’objet", class: "submit-form mb-5" %>
  <% end %>
</div>
