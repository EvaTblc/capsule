<div data-controller="image-preview">
  <%= form_with model: item,
                url: collection_category_items_path(collection, category),
                scope: :item,
                class: "form-capsule",
                data: { turbo_frame: "_top" } do |f| %>

    <!-- Champs cachés -->
    <%= f.hidden_field :type %>
    <%= f.hidden_field :source %>
    <%= f.hidden_field :source_id %>
    <%= f.hidden_field :barcode %>

    <!-- Input maître caché (seul utilisé par Rails) -->
    <%= f.file_field :photos,
          multiple: true,
          accept: "image/*",
          class: "hidden",
          data: { image_preview_target: "master" } %>

    <!-- Boutons séparés -->
    <div class="action-buttons">
      <div class="buttons-upload action-buttons">
        <label class="image-upload-label">
          Prendre une photo
          <input type="file"
                accept="image/*"
                capture="environment"
                class="hidden"
                data-action="change->image-preview#addFiles">
        </label>

        <label class="image-upload-label">
          Choisir depuis la galerie
          <input type="file"
                accept="image/*"
                multiple
                class="hidden"
                data-action="change->image-preview#addFiles">
        </label>
      </div>
    </div>

    <!-- Prévisualisation -->
    <div class="preview-grid new-grid mb-3" data-image-preview-target="list"></div>

    <!-- Champ Nom -->
    <%= f.text_field :name, class: "input-form" %>

    <!-- Exemplaires possédés -->
    <div class="label_add">
      <h4>Mes exemplaires</h4>
      <div id="item-copies">
        <%= f.fields_for :item_copies do |copy_form| %>
          <div class="item-copy-fields">
            <div class="copy-header" style="display: flex; justify-content: between;">
              <h5>Exemplaire</h5>
              <%= copy_form.check_box :_destroy, style: "display:none;" %>
              <button type="button" onclick="removeCopy(this)" class="btn-danger" style="margin-left: auto;">Supprimer</button>
            </div>

            <div class="copy-fields">
              <div>
                <%= copy_form.label :state, "État" %>
                <%= copy_form.select :state, options_for_select(ItemCopy::STATE.map { |s| [s, s] }), { prompt: "Choisir un état" }, { class: "input-form" } %>
              </div>

              <div>
                <%= copy_form.label :price, "Prix d'achat" %>
                <%= copy_form.number_field :price, step: 0.01, class: "input-form" %>
              </div>

              <div>
                <%= copy_form.label :purchase_date, "Date d'achat" %>
                <%= copy_form.date_field :purchase_date, class: "input-form" %>
              </div>

              <div>
                <%= copy_form.label :notes, "Notes" %>
                <%= copy_form.text_area :notes, rows: 2, class: "input-form" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <button type="button" onclick="addCopy()" class="btn-primary">Ajouter un exemplaire</button>
    </div>

    <script>
      function addCopy() {
        const container = document.getElementById('item-copies');
        const index = Date.now(); // Simple unique identifier

        const copyHtml = `
          <div class="item-copy-fields">
            <div class="copy-header" style="display: flex; justify-content: between;">
              <h5>Exemplaire</h5>
              <input type="hidden" name="item[item_copies_attributes][${index}][_destroy]" value="false">
              <button type="button" onclick="removeCopy(this)" class="btn-danger" style="margin-left: auto;">Supprimer</button>
            </div>

            <div class="copy-fields">
              <div>
                <label>État</label>
                <select name="item[item_copies_attributes][${index}][state]" class="input-form">
                  <option value="">Choisir un état</option>
                  <% ItemCopy::STATE.each do |state| %>
                    <option value="<%= state %>"><%= state %></option>
                  <% end %>
                </select>
              </div>

              <div>
                <label>Prix d'achat</label>
                <input type="number" step="0.01" name="item[item_copies_attributes][${index}][price]" class="input-form">
              </div>

              <div>
                <label>Date d'achat</label>
                <input type="date" name="item[item_copies_attributes][${index}][purchase_date]" class="input-form">
              </div>

              <div>
                <label>Notes</label>
                <textarea rows="2" name="item[item_copies_attributes][${index}][notes]" class="input-form"></textarea>
              </div>
            </div>
          </div>
        `;

        container.insertAdjacentHTML('beforeend', copyHtml);
      }

      function removeCopy(button) {
        const copyDiv = button.closest('.item-copy-fields');
        const destroyField = copyDiv.querySelector('input[name*="_destroy"]');
        if (destroyField) {
          destroyField.value = "1";
          copyDiv.style.display = 'none';
        } else {
          copyDiv.remove();
        }
      }

      // Add one copy by default if none exist
      document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('item-copies');
        if (container.children.length === 0) {
          addCopy();
        }
      });
    </script>

    <!-- Champs metadata -->
    <div class="label_add">
      <%= f.label :metadata_authors, "Auteur(s)" %>
      <%= text_field_tag "item[metadata][authors]", item.metadata["authors"], class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_publisher, "Éditeur" %>
      <%= text_field_tag "item[metadata][publisher]", item.metadata["publisher"], class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_language, "Langue" %>
      <%= select_tag "item[metadata][language]",
            options_for_select(ItemsHelper::LANGUAGE_NAMES.map { |k,v| [v, k] }, item.metadata["language"]),
            class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_published_date, "Année de publication" %>
      <%= text_field_tag "item[metadata][published_date]",
                        (Date.parse(item.metadata["published_date"]).strftime("%d-%m-%Y") rescue item.metadata["published_date"]),
                        class: "input-form" %>
    </div>

    <div class="label_add">
      <%= f.label :metadata_description, "Résumé" %>
      <%= text_area_tag "item[metadata][description]", item.metadata["description"], rows: 6, class: "input-form" %>
    </div>

    <!-- Bouton submit -->
    <%= f.submit "Créer l’objet", class: "submit-form mb-5" %>
  <% end %>
</div>
