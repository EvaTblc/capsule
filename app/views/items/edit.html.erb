<div class="container-scrollable" data-controller="image-preview">
  <h2 class="style-title"><%= @item.name %></h2>

  <%= form_with model: [@collection, @category, @item],
                url: collection_category_item_path(@collection, @category, @item),
                method: :patch,
                class: "form-capsule",
                data: { turbo_frame: "_top" },
                scope: :item do |f| %>

    <!-- Champs Item -->
    <%= f.text_field   :name,        placeholder: @item.name,        class: "input-form" %>
    <%= f.number_field :possession,  placeholder: "Nombre possédé",  class: "input-form" %>
    <%= f.select       :state, Item::STATE, { selected: @item.state }, class: "select-form" %>
    <%= f.date_field   :released_on,     placeholder: "Année",            class: "input-form" if @item.type == BookItem%>

    <!-- Tags imbriqués -->
    <div class="tags-fields">
      <%= f.fields_for :items_tags do |tag_form| %>
        <div class="tag-block">
          <%= tag_form.text_field   :name,     placeholder: "Nom du tag",       class: "input-form" %>
          <%= tag_form.text_area    :comments, placeholder: "Commentaires",     class: "input-form" %>
        </div>
      <% end %>
    </div>

    <!-- Bouton d’upload -->

      <%# <span data-image-preview-target="newImage"></span> %>
      <%= f.file_field :photos,
            id: "item_photos",
            multiple: true,
            accept: "image/*",
            class: "image-input",
            data: { action: "change->image-preview#update", image_preview_target: "input" } %>
    <label for="item_photos" class="image-upload-label">Choisir une image
    </label>

    <!-- Grille des photos existantes (même markup que les nouvelles) -->
    <% if @item.photos.attached? %>
      <div class="preview-grid existing-grid">
        <% @item.photos.each do |photo| %>
          <div class="preview-card">
            <img src="<%= url_for(photo) %>" alt="Photo existante">
            <button type="button"
                    class="remove-btn"
                    aria-label="Marquer pour suppression"
                    data-action="click->image-preview#toggleExisting"
                    data-photo-id="<%= photo.id %>">
              &#128465; <!-- 🗑️ -->
            </button>
          </div>
        <% end %>
      </div>
      <div data-image-preview-target="hiddenBag"></div>
    <% end %>

    <!-- Grille des nouvelles images (prévisualisation JS) -->
    <div class="preview-grid new-grid" data-image-preview-target="list"></div>


    <!-- Actions -->
    <div class="actions-save">
      <%= link_to "← Retour", collections_path, class: "btn-action" %>
      <%= f.submit "Sauvegarder", class: "btn-action", data: { disable_with: "Sauvegarde..." } %>
    </div>
  <% end %>
</div>
